name: Continuous Integration
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
jobs:
  build:
    runs-on: ubuntu-latest
    env: 
      CI_COMMIT_MESSAGE: Continuous Integration For Changing Tag in Test Repo
      CI_COMMIT_AUTHOR: Annaliskirwa
      CI_COMMIT_EMAIL: annaliskirwa@gmail.comx
      # IMAGE_TAG: $((RANDOM))
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.WORKFLOW_GIT_ACCESS_TOKEN }}
        repository: Annaliskirwa/_Test
        ref: 'master'
    - name: Clone the test repository
      run: |
        git clone https://github.com/Annaliskirwa/_Test.git
        # git clone https://Annaliskirwa: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@github.com/Annaliskirwa/_Test.git
        echo "Cloned the repository"
    - name: Switching to master
      run: |
        ls -la
        echo "Switching folders"
        cd _Test
        ls -la
        git switch master
        echo "Switched branch to master"
    - name: Update image tag for values.yaml file
      run: |
        cd _Test
        echo "Trying to update image tags"
        IMAGE_TAG=$((RANDOM))
        echo "$IMAGE_TAG"
        pwd
        if [ -f values.yaml ];
        ls -la
          then sed -ri '1,/^(\s*)(tag*)/ s/^(\s*)(tag*:[[:blank:]]*).*/\1tag: "${{ IMAGE_TAG }}"/'  values.yaml;
        fi
        # echo "updated the image tag to ${{ env.IMAGE_TAG }}"
        echo "updated the image tag to $IMAGE_TAG"
        cat values.yaml
    - name: Commit the changes
      run: |
        cd _Test
        pwd
        ls -la
        cat values.yaml
        git config --global user.name "${{ env.CI_COMMIT_AUTHOR }}"
        git config --global user.email "${{ env.CI_COMMIT_EMAIL }}"
        git add values.yaml
        git commit -am "${{ env.CI_COMMIT_MESSAGE }}"
        echo "Committed successfully"
    - name: Push the changes
      run: |
        cd _Test
        git push https://${{ secrets.WORKFLOW_GIT_ACCESS_TOKEN }}@github.com/Annaliskirwa/_Test.git HEAD:master --force
        echo "Pushed successfully"

    

